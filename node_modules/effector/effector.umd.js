((e,t)=>{'object'==typeof exports&&'undefined'!=typeof module?t(exports):'function'==typeof define&&define.amd?define(['exports'],t):t((e='undefined'!=typeof globalThis?globalThis:e||self).effector={})})(this,(e=>{function t(e,t){for(let r in e)t(e[r],r)}function r(e,t){e.forEach(t)}function a(e,t){if(!e)throw Error(t)}function n(e,t){ie={parent:ie,value:e,template:ee(e,'template')||se(),sidRoot:ee(e,'sidRoot')||ie&&ie.sidRoot};try{return t()}finally{ie=Y(ie)}}function o({node:e=[],from:t,source:a,parent:n=t||a,to:o,target:l,child:i=o||l,scope:s={},meta:f={},family:u={type:'regular'},regional:d}={}){let c=de(n),p=de(u.links),m=de(u.owners),g=[];r(e,(e=>e&&W(g,e)));let h={id:le(),seq:g,next:de(i),meta:f,scope:s,family:{type:u.type||M,links:p,owners:m}};return r(p,(e=>W(G(e),h))),r(m,(e=>W(J(e),h))),r(c,(e=>W(e.next,h))),d&&ie&&ue(Q(ie),[h]),h}function l(e,t,a){let n=Ge,o=null,l=Le;if(e.target&&(t=e.params,a=e.defer,n='page'in e?e.page:n,e.stack&&(o=e.stack),l=Z(e)||l,e=e.target),l&&Le&&l!==Le&&(Le=null),Array.isArray(e))for(let r=0;r<e.length;r++)Ee('pure',n,U(e[r]),o,t[r],l);else Ee('pure',n,U(e),o,t,l);if(a&&!We)return;let i,s,f,u,d,c,p={isRoot:We,currentPage:Ge,scope:Le,isWatch:He,isPure:Ue};We=0;e:for(;u=Pe();){let{idx:e,stack:t,type:a}=u;f=t.node,Ge=d=t.page,Le=Z(t),d?c=d.reg:Le&&(c=Le.reg);let n=!!d,o=!!Le,l={fail:0,scope:f.scope};i=s=0;for(let r=e;r<f.seq.length&&!i;r++){let u=f.seq[r];if(u.order){let{priority:n,barrierID:o}=u.order,l=o?d?`${d.fullID}_${o}`:o:0;if(r!==e||a!==n){o?Be.has(l)||(Be.add(l),Ve(r,t,n,o)):Ve(r,t,n);continue e}o&&Be.delete(l)}switch(u.type){case'mov':{let e,r=u.data;switch(r.from){case I:e=Q(t);break;case F:case'b':e=t[r.from];break;case q:e=r.store;break;case w:if(c&&!c[r.store.id])if(n){let e=Qe(d,r.store.id);t.page=d=e,e?c=e.reg:o?(Ye(Le,r.store,0,1,r.softRead),c=Le.reg):c=void 0}else o&&Ye(Le,r.store,0,1,r.softRead);e=Oe(c&&c[r.store.id]||r.store)}switch(r.to){case I:t.value=e;break;case F:case'b':t[r.to]=e;break;case w:Xe(d,Le,f,r.target).current=e}break}case'compute':let e=u.data;if(e.fn){He='watch'===ee(f,'op'),Ue=e.pure;let r=e.safe?(0,e.fn)(Q(t),l.scope,t):Ze(l,e.fn,t);e.filter?s=!r:t.value=r,He=p.isWatch,Ue=p.isPure}}i=l.fail||s}if(!i){let e=Q(t);r(f.next,(r=>{Ee('child',d,r,t,e,Z(t))}));let a=Z(t);if(a){ee(f,'needFxCounter')&&Ee('child',d,a.fxCount,t,e,a),ee(f,'storeChange')&&Ee('child',d,a.storeChange,t,e,a);let n=a.additionalLinks[f.id];n&&r(n,(r=>{Ee('child',d,r,t,e,a)}))}}}We=p.isRoot,Ge=p.currentPage,Le=Z(p)}function i(e,r="combine"){let a=r+'(',n='',o=0;return t(e,(e=>{o<25&&(null!=e&&(a+=n,a+=D(e)?re(e).fullName:e.toString()),o+=1,n=', ')})),a+')'}function s(e,t){let r,a,n=e;if(t){let n=re(t);0===e.length?(r=n.path,a=n.fullName):(r=n.path.concat([e]),a=0===n.fullName.length?e:n.fullName+'/'+e)}else r=0===e.length?[]:[e],a=e;return{shortName:n,fullName:a,path:r}}function f(e,t){let r=t?e:e[0];ge(r);let a=r.or,n=r.and;if(n){let r=t?n:n[0];if(ce(r)&&'and'in r){let r=f(n,t);e=r[0],a={...a,...r[1]}}else e=n}return[e,a]}function u(e,...t){let r=se();if(r){let a=r.handlers[e];if(a)return a(r,...t)}}function d(e,t){let r=(e,...t)=>(H(!ee(r,'derived'),'call of derived event','createEvent'),H(!Ue,'unit call from pure function','operators like sample'),Ge?((e,t,r,a)=>{let n=Ge,o=null;if(t)for(o=Ge;o&&o.template!==t;)o=Y(o);Ke(o);let l=e.create(r,a);return Ke(n),l})(r,a,e,t):r.create(e,t)),a=se();return Object.assign(r,{graphite:o({meta:ut(S,r,e,t),regional:1}),create:e=>(l({target:r,params:e,scope:Le}),e),watch:e=>st(r,e),map:e=>ct(r,A,e,[Ie()]),filter:e=>ct(r,"filter",e.fn?e:e.fn,[Ie(we,1)]),filterMap:e=>ct(r,'filterMap',e,[Ie(),Me((e=>!me(e)),1)]),prepend(e){let t=d('* \u2192 '+r.shortName,{parent:Y(r)});return u('eventPrepend',U(t)),lt(t,r,[Ie()],'prepend',e),ft(r,t),t}})}function c(e,t){let n=qe(e),i=dt('updates');u('storeBase',n);let s=n.id,f={subscribers:new Map,updates:i,defaultState:e,stateRef:n,getState(){let e,t=n;if(Ge){let t=Ge;for(;t&&!t.reg[s];)t=Y(t);t&&(e=t)}return!e&&Le&&(Ye(Le,n,1),e=Le),e&&(t=e.reg[s]),Oe(t)},setState:e=>l({target:f,params:e,defer:1,scope:Le}),reset:(...e)=>(r(e,(e=>f.on(e,(()=>f.defaultState)))),f),on:(e,t)=>(ye(e,'.on','first argument'),H(!ee(f,'derived'),'.on in derived store','createStore'),r(Array.isArray(e)?e:[e],(e=>{f.off(e),X(f).set(e,ot(pt(e,f,'on',ke,t)))})),f),off(e){let t=X(f).get(e);return t&&(t(),X(f).delete(e)),f},map(e,t){let r,a;ce(e)&&(r=e,e=e.fn),H(me(t),'second argument of store.map','updateFilter');let o=f.getState();se()?a=null:me(o)||(a=e(o,t));let l=c(a,{name:`${f.shortName} \u2192 *`,derived:1,and:r}),i=pt(f,l,A,ve,e);return Fe(K(l),{type:A,fn:e,from:n}),K(l).noInit=1,u('storeMap',n,i),l},watch(e,t){if(!t||!D(e)){let t=st(f,e);return u('storeWatch',n,e)||e(f.getState()),t}return a(pe(t),'second argument should be a function'),e.watch((e=>t(f.getState(),e)))}},d=ut(w,f,t),p=f.defaultConfig.updateFilter;f.graphite=o({scope:{state:n,fn:p},node:[Me(((e,t,r)=>(r.scope&&!r.scope.reg[n.id]&&(r.b=1),e))),Ae(n),Me(((e,t,{a:r,b:a})=>!me(e)&&(e!==r||a)),1),p&&Ie(ve,1),je({from:I,target:n})],child:i,meta:d,regional:1});let m=ee(f,'sid');return m&&('ignore'!==ee(f,'serialize')&&te(f,'storeChange',1),n.sid=m),a(ee(f,'derived')||!me(e),"current state can't be undefined, use null instead"),ue(f,[i]),f}function p(...e){let t,r,n;[e,n]=f(e);let o,l,i,s=e[e.length-1];if(pe(s)?(r=e.slice(0,-1),t=s):r=e,1===r.length){let e=r[0];_(e)||(o=e,l=1)}if(!l&&(o=r,t)){i=1;let e=t;t=t=>e(...t)}return a(ce(o),'shape should be an object'),mt(Array.isArray(o),!i,o,n,t)}function m(){let e={};return e.req=new Promise(((t,r)=>{e.rs=t,e.rj=r})),e.req.catch((()=>{})),e}function g(e,t){let r=d(pe(e)?{handler:e}:e,t),n=U(r);te(n,'op',r.kind=x),r.use=e=>(a(pe(e),'.use argument should be a function'),g.scope.handler=e,r),r.use.getCurrent=()=>g.scope.handler;let i=r.finally=dt('finally'),s=r.done=i.filterMap({named:'done',fn({status:e,params:t,result:r}){if('done'===e)return{params:t,result:r}}}),f=r.fail=i.filterMap({named:'fail',fn({status:e,params:t,error:r}){if('fail'===e)return{params:t,error:r}}}),u=r.doneData=s.map({named:'doneData',fn:({result:e})=>e}),p=r.failData=f.map({named:'failData',fn:({error:e})=>e}),g=o({scope:{handlerId:ee(n,'sid'),handler:r.defaultConfig.handler||(()=>a(0,`no handler used in ${r.getType()}`))},node:[Me(((e,t,r)=>{let a=t,n=a.handler;if(Z(r)){let e=Z(r).handlers[a.handlerId];e&&(n=e)}return e.handler=n,e}),0,1),Me((({params:e,req:t,handler:r,args:a=[e]},n,o)=>{let l=ht(e,t,1,i,o),s=ht(e,t,0,i,o),[f,u]=gt(r,s,a);f&&(ce(u)&&pe(u.then)?u.then(l,s):l(u))}),0,1)],meta:{op:'fx',fx:'runner'}});n.scope.runner=g,W(n.seq,Me(((e,{runner:t},r)=>{let a=Y(r)?{params:e,req:{rs(e){},rj(e){}}}:e;return l({target:t,params:a,defer:1,scope:Z(r)}),a.params}),0,1)),r.create=e=>{let t=m(),a={params:e,req:t};if(Le){if(!He){let e=Le;t.req.finally((()=>{Je(e)})).catch((()=>{}))}l({target:r,params:a,scope:Le})}else l(r,a);return t.req};let h=r.inFlight=c(0,{named:'inFlight'}).on(r,(e=>e+1)).on(i,(e=>e-1));te(i,'needFxCounter','dec'),te(r,'needFxCounter',1);let y=r.pending=h.map({fn:e=>e>0,named:'pending'});return ue(r,[i,s,f,u,p,y,h]),r}function h(e,t){ye(e,'merge','first argument');let r=d({name:i(e,'merge'),derived:1,and:t});return lt(e,r,[],'merge'),r}function y(e,t){let n=0;return r(bt,(r=>{r in e&&(a(null!=e[r],vt(t,r)),n=1)})),n}function b(e,t){let a=[];(function e(n){B(a,n)||(W(a,n),ee(n,'op')===w&&ee(n,'sid')&&t(n,ee(n,'sid')),r(n.next,e),r(G(n),e),r(J(n),e))})(e)}function v(e,t){if(Array.isArray(e)&&(e=new Map(e)),e instanceof Map){let n={};return r(e,((e,r)=>{a(D(r),'Map key should be a unit'),t&&t(r,e),a(r.sid,'unit should have a sid'),a(!(r.sid in n),'duplicate sid found'),n[r.sid]=e})),n}return e}let k='undefined'!=typeof Symbol&&Symbol.observable||'@@observable',w='store',S='event',x='effect',j='domain',$='scope',C='sampler',M='crosslink',A='map',I='stack',N='barrier',q='value',O='sample',F='a',D=e=>(pe(e)||ce(e))&&'kind'in e;const R=e=>t=>D(t)&&t.kind===e;let _=R(w),z=R(S),P=R(x),E=R(j),V=R($);var T={__proto__:null,unit:D,store:_,event:z,effect:P,domain:E,scope:V};let B=(e,t)=>e.includes(t),L=(e,t)=>{let r=e.indexOf(t);-1!==r&&e.splice(r,1)},W=(e,t)=>e.push(t),H=(e,t,r)=>!e&&console.error(`${t} is deprecated${r?`, use ${r} instead`:''}`),U=e=>e.graphite||e,G=e=>e.family.owners,J=e=>e.family.links,K=e=>e.stateRef,Q=e=>e.value,X=e=>e.subscribers,Y=e=>e.parent,Z=e=>e.scope,ee=(e,t)=>U(e).meta[t],te=(e,t,r)=>U(e).meta[t]=r,re=e=>e.compositeName;const ae=()=>{let e=0;return()=>""+ ++e};let ne=ae(),oe=ae(),le=ae(),ie=null,se=()=>ie&&ie.template,fe=e=>(e&&ie&&ie.sidRoot&&(e=`${ie.sidRoot}|${e}`),e),ue=(e,t)=>{let a=U(e);r(t,(e=>{let t=U(e);a.family.type!==j&&(t.family.type=M),W(G(t),a),W(J(a),t)}))},de=(e=[])=>(Array.isArray(e)?e:[e]).flat().map(U),ce=e=>'object'==typeof e&&null!==e,pe=e=>'function'==typeof e,me=e=>void 0===e,ge=e=>a(ce(e)||pe(e),'expect first argument be an object');const he=(e,t,r,n)=>a(!(!ce(e)&&!pe(e)||!('family'in e)&&!('graphite'in e)),`${t}: expect ${r} to be a unit (store, event or effect)${n}`);let ye=(e,t,a)=>{Array.isArray(e)?r(e,((e,r)=>he(e,t,`${r} item of ${a}`,''))):he(e,t,a,' or array of units')},be=(e,t,a="target")=>r(de(t),(t=>H(!ee(t,'derived'),`${e}: derived unit in "${a}"`,"createEvent/createStore"))),ve=(e,{fn:t},{a:r})=>t(e,r),ke=(e,{fn:t},{a:r})=>t(r,e),we=(e,{fn:t})=>t(e);const Se=(e,t,r,a)=>{let n={id:oe(),type:e,data:t};return r&&(n.order={priority:r},a&&(n.order.barrierID=++xe)),n};let xe=0,je=({from:e=w,store:t,target:r,to:a=(r?w:I),batch:n,priority:o})=>Se('mov',{from:e,store:t,to:a,target:r},o,n),$e=({fn:e,batch:t,priority:r,safe:a=0,filter:n=0,pure:o=0})=>Se('compute',{fn:e,safe:a,filter:n,pure:o},r,t),Ce=({fn:e})=>$e({fn:e,priority:x}),Me=(e,t,r)=>$e({fn:e,safe:1,filter:t,priority:r&&x}),Ae=(e,t,r)=>je({store:e,to:t?I:F,priority:r&&C,batch:1}),Ie=(e=we,t)=>$e({fn:e,pure:1,filter:t}),Ne={mov:je,compute:$e,filter:({fn:e,pure:t})=>$e({fn:e,filter:1,pure:t}),run:Ce},qe=e=>({id:oe(),current:e}),Oe=({current:e})=>e,Fe=(e,t)=>{e.before||(e.before=[]),W(e.before,t)},De=null;const Re=(e,t)=>{if(!e)return t;if(!t)return e;let r;return(e.v.type===t.v.type&&e.v.id>t.v.id||Te(e.v.type)>Te(t.v.type))&&(r=e,e=t,t=r),r=Re(e.r,t),e.r=e.l,e.l=r,e},_e=[];let ze=0;for(;ze<6;)W(_e,{first:null,last:null,size:0}),ze+=1;const Pe=()=>{for(let e=0;e<6;e++){let t=_e[e];if(t.size>0){if(3===e||4===e){t.size-=1;let e=De.v;return De=Re(De.l,De.r),e}1===t.size&&(t.last=null);let r=t.first;return t.first=r.r,t.size-=1,r.v}}},Ee=(e,t,r,a,n,o)=>Ve(0,{a:null,b:null,node:r,parent:a,value:n,page:t,scope:o},e),Ve=(e,t,r,a=0)=>{let n=Te(r),o=_e[n],l={v:{idx:e,stack:t,type:r,id:a},l:null,r:null};3===n||4===n?De=Re(De,l):(0===o.size?o.first=l:o.last.r=l,o.last=l),o.size+=1},Te=e=>{switch(e){case'child':return 0;case'pure':return 1;case'read':return 2;case N:return 3;case C:return 4;case x:return 5;default:return-1}},Be=new Set;let Le,We=1,He=0,Ue=0,Ge=null,Je=e=>{Le=e},Ke=e=>{Ge=e};const Qe=(e,t)=>{if(e){for(;e&&!e.reg[t];)e=Y(e);if(e)return e}return null};let Xe=(e,t,r,a,n)=>{let o=Qe(e,a.id);return o?o.reg[a.id]:t?(Ye(t,a,n),t.reg[a.id]):a},Ye=(e,t,a,n,o)=>{let l=e.reg,i=t.sid;if(l[t.id])return;let s={id:t.id,current:t.current};if(i&&i in e.sidValuesMap&&!(i in e.sidIdMap))s.current=e.sidValuesMap[i];else if(t.before&&!o){let o=0,i=a||!t.noInit||n;r(t.before,(t=>{switch(t.type){case A:{let r=t.from;if(r||t.fn){r&&Ye(e,r,a,n);let o=r&&l[r.id].current;i&&(s.current=t.fn?t.fn(o):o)}break}case'field':o||(o=1,s.current=Array.isArray(s.current)?[...s.current]:{...s.current}),Ye(e,t.from,a,n),i&&(s.current[t.field]=l[l[t.from.id].id].current)}}))}i&&(e.sidIdMap[i]=t.id),l[t.id]=s};const Ze=(e,t,r)=>{try{return t(Q(r),e.scope,r)}catch(t){console.error(t),e.fail=1}};let et=(e,r={})=>(ce(e)&&(et(e.or,r),t(e,((e,t)=>{me(e)||'or'===t||'and'===t||(r[t]=e)})),et(e.and,r)),r);const tt=(e,t)=>{L(e.next,t),L(G(e),t),L(J(e),t)},rt=(e,t,r)=>{let a;e.next.length=0,e.seq.length=0,e.scope=null;let n=J(e);for(;a=n.pop();)tt(a,e),(t||r&&'sample'!==ee(e,'op')||a.family.type===M)&&rt(a,t,'on'!==ee(a,'op')&&r);for(n=G(e);a=n.pop();)tt(a,e),r&&a.family.type===M&&rt(a,t,'on'!==ee(a,'op')&&r)},at=e=>e.clear();let nt=(e,{deep:t}={})=>{let r=0;if(e.ownerSet&&e.ownerSet.delete(e),_(e))at(X(e));else if(E(e)){r=1;let t=e.history;at(t.events),at(t.effects),at(t.stores),at(t.domains)}rt(U(e),!!t,r)},ot=e=>{let t=()=>nt(e);return t.unsubscribe=t,t},lt=(e,t,r,a,n)=>o({node:r,parent:e,child:t,scope:{fn:n},meta:{op:a},family:{owners:[e,t],links:t},regional:1}),st=(e,t)=>(a(pe(t),'.watch argument should be a function'),ot(o({scope:{fn:t},node:[Ce({fn:we})],parent:e,meta:{op:'watch'},family:{owners:e},regional:1}))),ft=(e,t,r=S)=>{Y(e)&&Y(e).hooks[r](t)},ut=(e,t,r,a)=>{let n=e===j,o=ne(),l=et({or:a,and:'string'==typeof r?{name:r}:r}),{parent:i=null,sid:f=null,named:u=null}=l,d=u||l.name||(n?'':o),c=s(d,i),p={op:t.kind=e,name:t.shortName=d,sid:t.sid=fe(f),named:u,unitId:t.id=o,serialize:l.serialize,derived:l.derived,config:l};if(t.parent=i,t.compositeName=c,t.defaultConfig=l,t.thru=e=>(H(0,'thru','js pipe'),e(t)),t.getType=()=>c.fullName,!n){t.subscribe=e=>(ge(e),t.watch(pe(e)?e:t=>e.next&&e.next(t))),t[k]=()=>t;let e=se();e&&(p.nativeTemplate=e)}return p},dt=e=>d({named:e});const ct=(e,t,r,a)=>{let n;ce(r)&&(n=r,r=r.fn);let o=d({name:`${e.shortName} \u2192 *`,derived:1,and:n});return lt(e,o,a,t,r),o},pt=(e,t,r,a,n)=>{let o=K(t),l=je({store:o,to:F,priority:'read'});r===A&&(l.data.softRead=1);let i=[l,Ie(a)];return u('storeOnMap',o,i,_(e)&&K(e)),lt(e,t,i,r,n)},mt=(e,r,n,o,l)=>{let s=e?e=>e.slice():e=>({...e}),f=e?[]:{},d=s(f),p=qe(d),m=qe(1);p.type=e?'list':'shape',p.noInit=1,u('combineBase',p,m);let g=c(d,{name:i(n),derived:1,and:o}),h=K(g);h.noInit=1,te(g,'isCombine',1);let y=Ae(p);y.order={priority:'barrier'};let b=[Me(((e,t,r)=>(r.scope&&!r.scope.reg[p.id]&&(r.c=1),e))),y,je({store:m,to:'b'}),Me(((e,{key:t},a)=>{if(a.c||e!==a.a[t])return r&&a.b&&(a.a=s(a.a)),a.a[t]=e,1}),1),je({from:F,target:p}),je({from:q,store:0,target:m}),je({from:q,store:1,target:m,priority:N,batch:1}),Ae(p,1),l&&Ie()];return t(n,((e,t)=>{if(!_(e))return a(!D(e)&&!me(e),`combine expects a store in a field ${t}`),void(d[t]=f[t]=e);f[t]=e.defaultState,d[t]=e.getState();let r=lt(e,g,b,'combine',l);r.scope.key=t;let n=K(e);Fe(p,{type:'field',field:t,from:n}),u('combineField',n,r)})),g.defaultShape=n,Fe(h,{type:A,from:p,fn:l}),se()||(g.defaultState=l?h.current=l(d):f),g};let gt=(e,t,r)=>{try{return[1,e(...r)]}catch(e){return t(e),[0,null]}},ht=(e,t,r,a,n)=>o=>l({target:[a,yt],params:[r?{status:'done',params:e,result:o}:{status:'fail',params:e,error:o},{value:o,fn:r?t.rs:t.rj}],defer:1,page:n.page,scope:Z(n)});const yt=o({node:[Ce({fn:({fn:e,value:t})=>e(t)})],meta:{op:'fx',fx:'sidechain'}}),bt=['source','clock','target'],vt=(e,t)=>e+`: ${t} should be defined`;let kt=(e,t,r,n,o,l,i,s,f,m,g,y)=>{let b=!!o;a(!me(r)||!me(t),vt(e,'either source or clock'));let v=0;me(r)?v=1:D(r)||(r=p(r)),me(t)?t=r:(ye(t,e,'clock'),Array.isArray(t)&&(t=h(t))),v&&(r=t),s||i||(i=r.shortName);let k='none';(g||n)&&(D(n)?k='unit':(a(pe(n),'`filter` should be function or unit'),k='fn')),o?(ye(o,e,'target'),be(e,o)):'none'===k&&m&&_(r)&&_(t)?o=c(l?l(Oe(K(r)),Oe(K(t))):Oe(K(r)),{name:i,sid:y,or:s}):(o=d({name:i,derived:1,or:s}),u('sampleTarget',U(o)));let w=qe(),S=[];if('unit'===k){let[r,a]=St(n,o,t,w,e);S=[...wt(a),...wt(r)]}let[x,j]=St(r,o,t,w,e);return ue(r,[lt(t,o,[u('sampleSourceLoader'),je({from:I,target:w}),...wt(j),Ae(x,1,f),...S,Ae(w),'fn'===k&&Ie(((e,t,{a:r})=>n(e,r)),1),l&&Ie(ve),u('sampleSourceUpward',b)],e,l)]),o};const wt=e=>[Ae(e),Me(((e,t,{a:r})=>r),1)],St=(e,t,r,a,n)=>{let l=_(e),i=l?K(e):qe(),s=qe(l);return l||o({parent:e,node:[je({from:I,target:i}),je({from:q,store:1,target:s})],family:{owners:[e,t,r],links:t},meta:{op:n},regional:1}),u('sampleSource',s,i,a),[i,s]},xt=(e,t,r,a)=>{let n=e[t];n&&l({target:n,params:Array.isArray(n)?n.map((()=>r)):r,defer:1,stack:a})};e.allSettled=(e,{scope:t,params:r})=>{if(!D(e))return Promise.reject(Error('first argument should be unit'));let a=m();a.parentFork=Le;let{fxCount:n}=t;W(n.scope.defers,a);let o=[e],i=[];return W(i,P(e)?{params:r,req:{rs(e){a.value={status:'done',value:e}},rj(e){a.value={status:'fail',value:e}}}}:r),W(o,n),W(i,null),l({target:o,params:i,scope:t}),a.req},e.attach=e=>{let t;[e,t]=f(e,1);let{source:r,effect:a,mapParams:n}=e,o=g(e,t);te(o,'attached',1);let i,{runner:u}=U(o).scope,d=Me(((e,t,a)=>{let i,{params:s,req:f,handler:u}=e,d=o.finally,c=ht(s,f,0,d,a),p=a.a,m=P(u),g=1;if(n?[g,i]=gt(n,c,[s,p]):i=r&&m?p:s,g){if(!m)return e.args=[p,i],1;l({target:u,params:{params:i,req:{rs:ht(s,f,1,d,a),rj:c}},page:a.page,defer:1})}}),1,1);if(r){let e;_(r)?(e=r,ue(e,[o])):(e=p(r),ue(o,[e])),i=[Ae(K(e)),d]}else i=[d];u.seq.splice(1,0,...i),o.use(a);let c=Y(a);return c&&(Object.assign(re(o),s(o.shortName,c)),o.defaultConfig.parent=c),ft(a,o,x),o},e.clearNode=nt,e.combine=p,e.createApi=(...e)=>{let[[r,a],n]=f(e),o={};return t(a,((e,t)=>{let a=o[t]=d(t,{parent:Y(r),config:n});r.on(a,e),ft(r,a)})),o},e.createDomain=function e(a,n){let i=o({family:{type:j},regional:1}),s={history:{},graphite:i,hooks:{}};i.meta=ut(j,s,a,n),t({Event:d,Effect:g,Store:c,Domain:e},((e,t)=>{let a=t.toLowerCase(),n=dt(`on${t}`);s.hooks[a]=n;let o=new Set;s.history[`${a}s`]=o,n.create=e=>(l(n,e),e),W(U(n).seq,Me(((e,t,r)=>(r.scope=null,e)))),n.watch((e=>{ue(s,[e]),o.add(e),e.ownerSet||(e.ownerSet=o),Y(e)||(e.parent=s)})),ue(s,[n]),s[`onCreate${t}`]=e=>(r(o,e),n.watch(e)),s[`create${t}`]=s[a]=(t,r)=>n(e(t,{parent:s,or:r}))}));let f=Y(s);return f&&t(s.hooks,((e,t)=>lt(e,f.hooks[t]))),s},e.createEffect=g,e.createEvent=d,e.createNode=o,e.createStore=c,e.createStoreObject=(...e)=>(H(0,'createStoreObject','combine'),p(...e)),e.fork=(e,t)=>{let n,l=e;E(e)&&(n=e,l=t);let i=(e=>{let t=o({scope:{defers:[],inFlight:0,fxID:0},node:[Me(((e,t,r)=>{Y(r)?'dec'===ee(Y(r).node,'needFxCounter')?t.inFlight-=1:(t.inFlight+=1,t.fxID+=1):t.fxID+=1})),$e({priority:C,batch:1}),Me(((e,t)=>{let{defers:a,fxID:n}=t;t.inFlight>0||0===a.length||Promise.resolve().then((()=>{t.fxID===n&&r(a.splice(0,a.length),(e=>{Je(e.parentFork),e.rs(e.value)}))}))}),0,1)]}),a=o({node:[Me(((e,t,r)=>{let a=Y(r);if(a&&Y(a)){let t=a.node;if(!ee(t,'isCombine')||'combine'!==ee(Y(a).node,'op')){let a=Z(r),n=t.scope.state.id,o=ee(t,'sid');a.sidIdMap[o]=n,a.sidValuesMap[o]=e}}}))]}),n={cloneOf:e,reg:{},sidValuesMap:{},sidIdMap:{},getState(e){if('current'in e)return Xe(Ge,n,null,e).current;let t=U(e);return Xe(Ge,n,t,t.scope.state,1).current},kind:$,graphite:o({family:{type:j,links:[t,a]},meta:{unit:'fork'},scope:{forkInFlightCounter:t}}),additionalLinks:{},handlers:{},fxCount:t,storeChange:a};return n})(n);if(l){if(l.values){let e=v(l.values,(e=>a(_(e),'Values map can contain only stores as keys')));Object.assign(i.sidValuesMap,e)}l.handlers&&(i.handlers=v(l.handlers,(e=>a(P(e),"Handlers map can contain only effects as keys"))))}return i},e.forward=e=>{let t='forward',[{from:r,to:a},n]=f(e,1);return ye(r,t,'"from"'),ye(a,t,'"to"'),be(t,a,'to'),ot(o({parent:r,child:a,meta:{op:t,config:n},family:{},regional:1}))},e.fromObservable=e=>{ge(e);let t=k in e?e[k]():e;a(t.subscribe,'expect observable to have .subscribe');let r=d(),n=ot(r);return t.subscribe({next:r,error:n,complete:n}),r},e.guard=(...e)=>{let[[t,r],a]=f(e);return r||(r=t,t=r.source),y(r,'guard'),kt('guard',r.clock,t,r.filter,r.target,null,r.name,a,!r.greedy,0,1)},e.hydrate=(e,{values:t})=>{a(ce(t),'values property should be an object');let r,n,o,i=v(t),s=Object.getOwnPropertyNames(i),f=[],u=[];V(e)?(r=e,o=1,a(r.cloneOf,'scope should be created from domain'),n=U(r.cloneOf)):E(e)?n=U(e):a(0,'first argument of hydrate should be domain or scope'),b(n,((e,t)=>{B(s,t)&&(W(f,e),W(u,i[t]))})),l({target:f,params:u,scope:r}),o&&Object.assign(r.sidValuesMap,i)},e.is=T,e.launch=l,e.merge=h,e.restore=(e,r,a)=>{if(_(e))return H(0,'restore($store)'),e;if(z(e)||P(e)){let t=Y(e),n=c(r,{parent:t,name:e.shortName,and:a});return lt(P(e)?e.doneData:e,n),t&&t.hooks.store(n),n}let n=Array.isArray(e)?[]:{};return t(e,((e,t)=>n[t]=_(e)?e:c(e,{name:t}))),n},e.sample=(...e)=>{let t,r,a,n,[[o,l,i],s]=f(e),u=1;return me(l)&&ce(o)&&y(o,O)&&(l=o.clock,i=o.fn,u=!o.greedy,n=o.filter,t=o.target,r=o.name,a=o.sid,o=o.source),kt(O,l,o,n,t,i,r,s,u,1,0,a)},e.scopeBind=(e,{scope:t}={})=>{a(t||Le,'scopeBind cannot be called outside of forked .watch');let r=t||Le;return P(e)?t=>{let a=m();return l({target:e,params:{params:t,req:a},scope:r}),a.req}:t=>(l({target:e,params:t,scope:r}),t)},e.serialize=(e,r={})=>{let n=r.ignore?r.ignore.map((({sid:e})=>e)):[],o={};return t(e.sidValuesMap,((t,r)=>{if(B(n,r))return;let a=e.sidIdMap[r];o[r]=a&&a in e.reg?e.reg[a].current:t})),'onlyChanges'in r&&!r.onlyChanges&&(a(e.cloneOf,'scope should be created from domain'),b(U(e.cloneOf),((t,r)=>{r in o||B(n,r)||ee(t,'isCombine')||'ignore'===ee(t,'serialize')||(o[r]=e.getState(t))}))),o},e.setStoreName=(e,t)=>{e.shortName=t,Object.assign(re(e),s(t,Y(e)))},e.split=(...e)=>{let r,n,l='split',[[i,s],c]=f(e),p=!s;p&&(r=i.cases,s=i.match,n=i.clock,i=i.source);let m=_(s),g=!D(s)&&pe(s),h=!m&&!g&&ce(s);r||(r={}),p?t(r,((e,t)=>be(l,e,`cases.${t}`))):(a(h,'match should be an object'),t(s,((e,t)=>r[t]=d({derived:1,and:c}))),r.__=d({derived:1,and:c}));let y,b=new Set([].concat(i,n||[],Object.values(r))),v=Object.keys(m||g?r:s);if(m||g)m&&b.add(s),y=[m&&Ae(K(s),0,1),$e({safe:m,filter:1,pure:!m,fn(e,t,r){let a=String(m?r.a:s(e));xt(t,B(v,a)?a:'__',e,r)}})];else if(h){let e=qe({});e.type='shape';let r,a=[];t(s,((t,n)=>{if(D(t)){r=1,W(a,n),b.add(t);let o=lt(t,[],[Ae(e),Me(((e,t,{a:r})=>r[n]=e))]);if(_(t)){e.current[n]=t.getState();let r=K(t);Fe(e,{from:r,field:n,type:'field'}),u('splitMatchStore',r,o)}}})),r&&u('splitBase',e),y=[r&&Ae(e,0,1),Ie(((e,t,r)=>{for(let n=0;n<v.length;n++){let o=v[n];if(B(a,o)?r.a[o]:s[o](e))return void xt(t,o,e,r)}xt(t,'__',e,r)}),1)]}else a(0,'expect match to be unit, function or object');let k=o({meta:{op:l},parent:n?[]:i,scope:r,node:y,family:{owners:Array.from(b)},regional:1});if(n&&kt(l,n,i,null,k,null,l,c,0,0,0),!p)return r},e.step=Ne,e.version="22.2.0",e.withFactory=({sid:e,name:t,loc:r,method:a,fn:l})=>n(o({meta:{sidRoot:fe(e),name:t,loc:r,method:a}}),l),e.withRegion=n,Object.defineProperty(e,'__esModule',{value:1})}));
//# sourceMappingURL=effector.umd.js.map
