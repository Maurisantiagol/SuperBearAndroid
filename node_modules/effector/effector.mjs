function e(e,t){for(let r in e)t(e[r],r)}function t(e,t){e.forEach(t)}function r(e,t){if(!e)throw Error(t)}function n(e,t){ue={parent:ue,value:e,template:ne(e,'template')||ce(),sidRoot:ne(e,'sidRoot')||ue&&ue.sidRoot};try{return t()}finally{ue=te(ue)}}function a({node:e=[],from:r,source:n,parent:a=r||n,to:o,target:l,child:i=o||l,scope:s={},meta:f={},family:u={type:'regular'},regional:c}={}){let d=ge(a),p=ge(u.links),m=ge(u.owners),g=[];t(e,(e=>e&&G(g,e)));let h={id:fe(),seq:g,next:ge(i),meta:f,scope:s,family:{type:u.type||"crosslink",links:p,owners:m}};return t(p,(e=>G(Q(e),h))),t(m,(e=>G(X(e),h))),t(d,(e=>G(e.next,h))),c&&ue&&me(Z(ue),[h]),h}function o(e,r,n){let a=Xe,o=null,l=Ge;if(e.target&&(r=e.params,n=e.defer,a='page'in e?e.page:a,e.stack&&(o=e.stack),l=re(e)||l,e=e.target),l&&Ge&&l!==Ge&&(Ge=null),Array.isArray(e))for(let t=0;t<e.length;t++)Te('pure',a,K(e[t]),o,r[t],l);else Te('pure',a,K(e),o,r,l);if(n&&!Je)return;let i,s,f,u,c,d,p={isRoot:Je,currentPage:Xe,scope:Ge,isWatch:Ke,isPure:Qe};Je=0;e:for(;u=Le();){let{idx:e,stack:r,type:n}=u;f=r.node,Xe=c=r.page,Ge=re(r),c?d=c.reg:Ge&&(d=Ge.reg);let a=!!c,o=!!Ge,l={fail:0,scope:f.scope};i=s=0;for(let t=e;t<f.seq.length&&!i;t++){let u=f.seq[t];if(u.order){let{priority:a,barrierID:o}=u.order,l=o?c?`${c.fullID}_${o}`:o:0;if(t!==e||n!==a){o?Ue.has(l)||(Ue.add(l),We(t,r,a,o)):We(t,r,a);continue e}o&&Ue.delete(l)}switch(u.type){case'mov':{let e,t=u.data;switch(t.from){case z:e=Z(r);break;case"a":case'b':e=r[t.from];break;case"value":e=t.store;break;case"store":if(d&&!d[t.store.id])if(a){let e=et(c,t.store.id);r.page=c=e,e?d=e.reg:o?(rt(Ge,t.store,0,1,t.softRead),d=Ge.reg):d=void 0}else o&&rt(Ge,t.store,0,1,t.softRead);e=ze(d&&d[t.store.id]||t.store)}switch(t.to){case z:r.value=e;break;case"a":case'b':r[t.to]=e;break;case"store":tt(c,Ge,f,t.target).current=e}break}case'compute':let e=u.data;if(e.fn){Ke='watch'===ne(f,'op'),Qe=e.pure;let t=e.safe?(0,e.fn)(Z(r),l.scope,r):nt(l,e.fn,r);e.filter?s=!t:r.value=t,Ke=p.isWatch,Qe=p.isPure}}i=l.fail||s}if(!i){let e=Z(r);t(f.next,(t=>{Te('child',c,t,r,e,re(r))}));let n=re(r);if(n){ne(f,'needFxCounter')&&Te('child',c,n.fxCount,r,e,n),ne(f,'storeChange')&&Te('child',c,n.storeChange,r,e,n);let a=n.additionalLinks[f.id];a&&t(a,(t=>{Te('child',c,t,r,e,n)}))}}}Je=p.isRoot,Xe=p.currentPage,Ge=re(p)}function l(t,r="combine"){let n=r+'(',a='',o=0;return e(t,(e=>{o<25&&(null!=e&&(n+=a,n+=_(e)?oe(e).fullName:e.toString()),o+=1,a=', ')})),n+')'}function i(e,t){e.shortName=t,Object.assign(oe(e),s(t,te(e)))}function s(e,t){let r,n,a=e;if(t){let a=oe(t);0===e.length?(r=a.path,n=a.fullName):(r=a.path.concat([e]),n=0===a.fullName.length?e:a.fullName+'/'+e)}else r=0===e.length?[]:[e],n=e;return{shortName:a,fullName:n,path:r}}function f(e,t){let r=t?e:e[0];ve(r);let n=r.or,a=r.and;if(a){let r=t?a:a[0];if(he(r)&&'and'in r){let r=f(a,t);e=r[0],n={...n,...r[1]}}else e=a}return[e,n]}function u(e,...t){let r=ce();if(r){let n=r.handlers[e];if(n)return n(r,...t)}}function c(e,t){let r=(e,...t)=>(J(!ne(r,'derived'),'call of derived event','createEvent'),J(!Qe,'unit call from pure function','operators like sample'),Xe?((e,t,r,n)=>{let a=Xe,o=null;if(t)for(o=Xe;o&&o.template!==t;)o=te(o);Ze(o);let l=e.create(r,n);return Ze(a),l})(r,n,e,t):r.create(e,t)),n=ce();return Object.assign(r,{graphite:a({meta:gt("event",r,e,t),regional:1}),create:e=>(o({target:r,params:e,scope:Ge}),e),watch:e=>pt(r,e),map:e=>yt(r,R,e,[Fe()]),filter:e=>yt(r,"filter",e.fn?e:e.fn,[Fe(Ce,1)]),filterMap:e=>yt(r,'filterMap',e,[Fe(),Ne((e=>!be(e)),1)]),prepend(e){let t=c('* \u2192 '+r.shortName,{parent:te(r)});return u('eventPrepend',K(t)),ct(t,r,[Fe()],'prepend',e),mt(r,t),t}})}function d(e,n){let l=Re(e),i=ht('updates');u('storeBase',l);let s=l.id,f={subscribers:new Map,updates:i,defaultState:e,stateRef:l,getState(){let e,t=l;if(Xe){let t=Xe;for(;t&&!t.reg[s];)t=te(t);t&&(e=t)}return!e&&Ge&&(rt(Ge,l,1),e=Ge),e&&(t=e.reg[s]),ze(t)},setState:e=>o({target:f,params:e,defer:1,scope:Ge}),reset:(...e)=>(t(e,(e=>f.on(e,(()=>f.defaultState)))),f),on:(e,r)=>(we(e,'.on','first argument'),J(!ne(f,'derived'),'.on in derived store','createStore'),t(Array.isArray(e)?e:[e],(e=>{f.off(e),ee(f).set(e,ut(bt(e,f,'on',$e,r)))})),f),off(e){let t=ee(f).get(e);return t&&(t(),ee(f).delete(e)),f},map(e,t){let r,n;he(e)&&(r=e,e=e.fn),J(be(t),'second argument of store.map','updateFilter');let a=f.getState();ce()?n=null:be(a)||(n=e(a,t));let o=d(n,{name:`${f.shortName} \u2192 *`,derived:1,and:r}),i=bt(f,o,R,Se,e);return _e(Y(o),{type:R,fn:e,from:l}),Y(o).noInit=1,u('storeMap',l,i),o},watch(e,t){if(!t||!_(e)){let t=pt(f,e);return u('storeWatch',l,e)||e(f.getState()),t}return r(ye(t),'second argument should be a function'),e.watch((e=>t(f.getState(),e)))}},c=gt("store",f,n),p=f.defaultConfig.updateFilter;f.graphite=a({scope:{state:l,fn:p},node:[Ne(((e,t,r)=>(r.scope&&!r.scope.reg[l.id]&&(r.b=1),e))),Oe(l),Ne(((e,t,{a:r,b:n})=>!be(e)&&(e!==r||n)),1),p&&Fe(Se,1),Ae({from:z,target:l})],child:i,meta:c,regional:1});let m=ne(f,'sid');return m&&('ignore'!==ne(f,'serialize')&&ae(f,'storeChange',1),l.sid=m),r(ne(f,'derived')||!be(e),"current state can't be undefined, use null instead"),me(f,[i]),f}function p(...e){let t,n,a;[e,a]=f(e);let o,l,i,s=e[e.length-1];if(ye(s)?(n=e.slice(0,-1),t=s):n=e,1===n.length){let e=n[0];V(e)||(o=e,l=1)}if(!l&&(o=n,t)){i=1;let e=t;t=t=>e(...t)}return r(he(o),'shape should be an object'),vt(Array.isArray(o),!i,o,a,t)}function m(...e){return J(0,'createStoreObject','combine'),p(...e)}function g(){let e={};return e.req=new Promise(((t,r)=>{e.rs=t,e.rj=r})),e.req.catch((()=>{})),e}function h(e,t){let n=c(ye(e)?{handler:e}:e,t),l=K(n);ae(l,'op',n.kind="effect"),n.use=e=>(r(ye(e),'.use argument should be a function'),m.scope.handler=e,n),n.use.getCurrent=()=>m.scope.handler;let i=n.finally=ht('finally'),s=n.done=i.filterMap({named:'done',fn({status:e,params:t,result:r}){if('done'===e)return{params:t,result:r}}}),f=n.fail=i.filterMap({named:'fail',fn({status:e,params:t,error:r}){if('fail'===e)return{params:t,error:r}}}),u=n.doneData=s.map({named:'doneData',fn:({result:e})=>e}),p=n.failData=f.map({named:'failData',fn:({error:e})=>e}),m=a({scope:{handlerId:ne(l,'sid'),handler:n.defaultConfig.handler||(()=>r(0,`no handler used in ${n.getType()}`))},node:[Ne(((e,t,r)=>{let n=t,a=n.handler;if(re(r)){let e=re(r).handlers[n.handlerId];e&&(a=e)}return e.handler=a,e}),0,1),Ne((({params:e,req:t,handler:r,args:n=[e]},a,o)=>{let l=wt(e,t,1,i,o),s=wt(e,t,0,i,o),[f,u]=kt(r,s,n);f&&(he(u)&&ye(u.then)?u.then(l,s):l(u))}),0,1)],meta:{op:'fx',fx:'runner'}});l.scope.runner=m,G(l.seq,Ne(((e,{runner:t},r)=>{let n=te(r)?{params:e,req:{rs(e){},rj(e){}}}:e;return o({target:t,params:n,defer:1,scope:re(r)}),n.params}),0,1)),n.create=e=>{let t=g(),r={params:e,req:t};if(Ge){if(!Ke){let e=Ge;t.req.finally((()=>{Ye(e)})).catch((()=>{}))}o({target:n,params:r,scope:Ge})}else o(n,r);return t.req};let h=n.inFlight=d(0,{named:'inFlight'}).on(n,(e=>e+1)).on(i,(e=>e-1));ae(i,'needFxCounter','dec'),ae(n,'needFxCounter',1);let y=n.pending=h.map({fn:e=>e>0,named:'pending'});return me(n,[i,s,f,u,p,y,h]),n}function y(e){let t;[e,t]=f(e,1);let{source:r,effect:n,mapParams:a}=e,l=h(e,t);ae(l,'attached',1);let i,{runner:u}=K(l).scope,c=Ne(((e,t,n)=>{let i,{params:s,req:f,handler:u}=e,c=l.finally,d=wt(s,f,0,c,n),p=n.a,m=B(u),g=1;if(a?[g,i]=kt(a,d,[s,p]):i=r&&m?p:s,g){if(!m)return e.args=[p,i],1;o({target:u,params:{params:i,req:{rs:wt(s,f,1,c,n),rj:d}},page:n.page,defer:1})}}),1,1);if(r){let e;V(r)?(e=r,me(e,[l])):(e=p(r),me(l,[e])),i=[Oe(Y(e)),c]}else i=[c];u.seq.splice(1,0,...i),l.use(n);let d=te(n);return d&&(Object.assign(oe(l),s(l.shortName,d)),l.defaultConfig.parent=d),mt(n,l,"effect"),l}function b(...t){let[[r,n],a]=f(t),o={};return e(n,((e,t)=>{let n=o[t]=c(t,{parent:te(r),config:a});r.on(n,e),mt(r,n)})),o}function v(r,n){let l=a({family:{type:"domain"},regional:1}),i={history:{},graphite:l,hooks:{}};l.meta=gt("domain",i,r,n),e({Event:c,Effect:h,Store:d,Domain:v},((e,r)=>{let n=r.toLowerCase(),a=ht(`on${r}`);i.hooks[n]=a;let l=new Set;i.history[`${n}s`]=l,a.create=e=>(o(a,e),e),G(K(a).seq,Ne(((e,t,r)=>(r.scope=null,e)))),a.watch((e=>{me(i,[e]),l.add(e),e.ownerSet||(e.ownerSet=l),te(e)||(e.parent=i)})),me(i,[a]),i[`onCreate${r}`]=e=>(t(l,e),a.watch(e)),i[`create${r}`]=i[n]=(t,r)=>a(e(t,{parent:i,or:r}))}));let s=te(i);return s&&e(i.hooks,((e,t)=>ct(e,s.hooks[t]))),i}function k(e){ve(e);let t=D in e?e[D]():e;r(t.subscribe,'expect observable to have .subscribe');let n=c(),a=ut(n);return t.subscribe({next:n,error:a,complete:a}),n}function w(e,t){we(e,'merge','first argument');let r=c({name:l(e,'merge'),derived:1,and:t});return ct(e,r,[],'merge'),r}function x(e,n){let a=0;return t(St,(t=>{t in e&&(r(null!=e[t],$t(n,t)),a=1)})),a}function S(...e){let t,r,n,a,[[o,l,i],s]=f(e),u=1;return be(l)&&he(o)&&x(o,"sample")&&(l=o.clock,i=o.fn,u=!o.greedy,a=o.filter,t=o.target,r=o.name,n=o.sid,o=o.source),Ct("sample",l,o,a,t,i,r,s,u,1,0,n)}function $(...e){let[[t,r],n]=f(e);return r||(r=t,t=r.source),x(r,'guard'),Ct('guard',r.clock,t,r.filter,r.target,null,r.name,n,!r.greedy,0,1)}function C(t,r,n){if(V(t))return J(0,'restore($store)'),t;if(E(t)||B(t)){let e=te(t),a=d(r,{parent:e,name:t.shortName,and:n});return ct(B(t)?t.doneData:t,a),e&&e.hooks.store(a),a}let a=Array.isArray(t)?[]:{};return e(t,((e,t)=>a[t]=V(e)?e:d(e,{name:t}))),a}function M(...t){let n,o,l='split',[[i,s],d]=f(t),p=!s;p&&(n=i.cases,s=i.match,o=i.clock,i=i.source);let m=V(s),g=!_(s)&&ye(s),h=!m&&!g&&he(s);n||(n={}),p?e(n,((e,t)=>xe(l,e,`cases.${t}`))):(r(h,'match should be an object'),e(s,((e,t)=>n[t]=c({derived:1,and:d}))),n.__=c({derived:1,and:d}));let y,b=new Set([].concat(i,o||[],Object.values(n))),v=Object.keys(m||g?n:s);if(m||g)m&&b.add(s),y=[m&&Oe(Y(s),0,1),Ie({safe:m,filter:1,pure:!m,fn(e,t,r){let n=String(m?r.a:s(e));At(t,H(v,n)?n:'__',e,r)}})];else if(h){let t=Re({});t.type='shape';let r,n=[];e(s,((e,a)=>{if(_(e)){r=1,G(n,a),b.add(e);let o=ct(e,[],[Oe(t),Ne(((e,t,{a:r})=>r[a]=e))]);if(V(e)){t.current[a]=e.getState();let r=Y(e);_e(t,{from:r,field:a,type:'field'}),u('splitMatchStore',r,o)}}})),r&&u('splitBase',t),y=[r&&Oe(t,0,1),Fe(((e,t,r)=>{for(let a=0;a<v.length;a++){let o=v[a];if(H(n,o)?r.a[o]:s[o](e))return void At(t,o,e,r)}At(t,'__',e,r)}),1)]}else r(0,'expect match to be unit, function or object');let k=a({meta:{op:l},parent:o?[]:i,scope:n,node:y,family:{owners:Array.from(b)},regional:1});if(o&&Ct(l,o,i,null,k,null,l,d,0,0,0),!p)return n}function j(e,{scope:t,params:r}){if(!_(e))return Promise.reject(Error('first argument should be unit'));let n=g();n.parentFork=Ge;let{fxCount:a}=t;G(a.scope.defers,n);let l=[e],i=[];return G(i,B(e)?{params:r,req:{rs(e){n.value={status:'done',value:e}},rj(e){n.value={status:'fail',value:e}}}}:r),G(l,a),G(i,null),o({target:l,params:i,scope:t}),n.req}function A(e,r){let n=[];(function e(a){H(n,a)||(G(n,a),"store"===ne(a,'op')&&ne(a,'sid')&&r(a,ne(a,'sid')),t(a.next,e),t(Q(a),e),t(X(a),e))})(e)}function I(e,n){if(Array.isArray(e)&&(e=new Map(e)),e instanceof Map){let a={};return t(e,((e,t)=>{r(_(t),'Map key should be a unit'),n&&n(t,e),r(t.sid,'unit should have a sid'),r(!(t.sid in a),'duplicate sid found'),a[t.sid]=e})),a}return e}function q(e,n){let o,l=e;L(e)&&(o=e,l=n);let i=(e=>{let r=a({scope:{defers:[],inFlight:0,fxID:0},node:[Ne(((e,t,r)=>{te(r)?'dec'===ne(te(r).node,'needFxCounter')?t.inFlight-=1:(t.inFlight+=1,t.fxID+=1):t.fxID+=1})),Ie({priority:"sampler",batch:1}),Ne(((e,r)=>{let{defers:n,fxID:a}=r;r.inFlight>0||0===n.length||Promise.resolve().then((()=>{r.fxID===a&&t(n.splice(0,n.length),(e=>{Ye(e.parentFork),e.rs(e.value)}))}))}),0,1)]}),n=a({node:[Ne(((e,t,r)=>{let n=te(r);if(n&&te(n)){let t=n.node;if(!ne(t,'isCombine')||'combine'!==ne(te(n).node,'op')){let n=re(r),a=t.scope.state.id,o=ne(t,'sid');n.sidIdMap[o]=a,n.sidValuesMap[o]=e}}}))]}),o={cloneOf:e,reg:{},sidValuesMap:{},sidIdMap:{},getState(e){if('current'in e)return tt(Xe,o,null,e).current;let t=K(e);return tt(Xe,o,t,t.scope.state,1).current},kind:"scope",graphite:a({family:{type:"domain",links:[r,n]},meta:{unit:'fork'},scope:{forkInFlightCounter:r}}),additionalLinks:{},handlers:{},fxCount:r,storeChange:n};return o})(o);if(l){if(l.values){let e=I(l.values,(e=>r(V(e),'Values map can contain only stores as keys')));Object.assign(i.sidValuesMap,e)}l.handlers&&(i.handlers=I(l.handlers,(e=>r(B(e),"Handlers map can contain only effects as keys"))))}return i}function N(e,{values:t}){r(he(t),'values property should be an object');let n,a,l,i=I(t),s=Object.getOwnPropertyNames(i),f=[],u=[];T(e)?(n=e,l=1,r(n.cloneOf,'scope should be created from domain'),a=K(n.cloneOf)):L(e)?a=K(e):r(0,'first argument of hydrate should be domain or scope'),A(a,((e,t)=>{H(s,t)&&(G(f,e),G(u,i[t]))})),o({target:f,params:u,scope:n}),l&&Object.assign(n.sidValuesMap,i)}function O(e,{scope:t}={}){r(t||Ge,'scopeBind cannot be called outside of forked .watch');let n=t||Ge;return B(e)?t=>{let r=g();return o({target:e,params:{params:t,req:r},scope:n}),r.req}:t=>(o({target:e,params:t,scope:n}),t)}function F(t,n={}){let a=n.ignore?n.ignore.map((({sid:e})=>e)):[],o={};return e(t.sidValuesMap,((e,r)=>{if(H(a,r))return;let n=t.sidIdMap[r];o[r]=n&&n in t.reg?t.reg[n].current:e})),'onlyChanges'in n&&!n.onlyChanges&&(r(t.cloneOf,'scope should be created from domain'),A(K(t.cloneOf),((e,r)=>{r in o||H(a,r)||ne(e,'isCombine')||'ignore'===ne(e,'serialize')||(o[r]=t.getState(e))}))),o}let D='undefined'!=typeof Symbol&&Symbol.observable||'@@observable',R='map',z='stack',_=e=>(ye(e)||he(e))&&'kind'in e;const P=e=>t=>_(t)&&t.kind===e;let V=P("store"),E=P("event"),B=P("effect"),L=P("domain"),T=P("scope");var W={__proto__:null,unit:_,store:V,event:E,effect:B,domain:L,scope:T};let H=(e,t)=>e.includes(t),U=(e,t)=>{let r=e.indexOf(t);-1!==r&&e.splice(r,1)},G=(e,t)=>e.push(t),J=(e,t,r)=>!e&&console.error(`${t} is deprecated${r?`, use ${r} instead`:''}`),K=e=>e.graphite||e,Q=e=>e.family.owners,X=e=>e.family.links,Y=e=>e.stateRef,Z=e=>e.value,ee=e=>e.subscribers,te=e=>e.parent,re=e=>e.scope,ne=(e,t)=>K(e).meta[t],ae=(e,t,r)=>K(e).meta[t]=r,oe=e=>e.compositeName;const le=()=>{let e=0;return()=>""+ ++e};let ie=le(),se=le(),fe=le(),ue=null,ce=()=>ue&&ue.template,de=e=>(e&&ue&&ue.sidRoot&&(e=`${ue.sidRoot}|${e}`),e),pe=({sid:e,name:t,loc:r,method:o,fn:l})=>n(a({meta:{sidRoot:de(e),name:t,loc:r,method:o}}),l),me=(e,r)=>{let n=K(e);t(r,(e=>{let t=K(e);"domain"!==n.family.type&&(t.family.type="crosslink"),G(Q(t),n),G(X(n),t)}))},ge=(e=[])=>(Array.isArray(e)?e:[e]).flat().map(K),he=e=>'object'==typeof e&&null!==e,ye=e=>'function'==typeof e,be=e=>void 0===e,ve=e=>r(he(e)||ye(e),'expect first argument be an object');const ke=(e,t,n,a)=>r(!(!he(e)&&!ye(e)||!('family'in e)&&!('graphite'in e)),`${t}: expect ${n} to be a unit (store, event or effect)${a}`);let we=(e,r,n)=>{Array.isArray(e)?t(e,((e,t)=>ke(e,r,`${t} item of ${n}`,''))):ke(e,r,n,' or array of units')},xe=(e,r,n="target")=>t(ge(r),(t=>J(!ne(t,'derived'),`${e}: derived unit in "${n}"`,"createEvent/createStore"))),Se=(e,{fn:t},{a:r})=>t(e,r),$e=(e,{fn:t},{a:r})=>t(r,e),Ce=(e,{fn:t})=>t(e);const Me=(e,t,r,n)=>{let a={id:se(),type:e,data:t};return r&&(a.order={priority:r},n&&(a.order.barrierID=++je)),a};let je=0,Ae=({from:e="store",store:t,target:r,to:n=(r?"store":z),batch:a,priority:o})=>Me('mov',{from:e,store:t,to:n,target:r},o,a),Ie=({fn:e,batch:t,priority:r,safe:n=0,filter:a=0,pure:o=0})=>Me('compute',{fn:e,safe:n,filter:a,pure:o},r,t),qe=({fn:e})=>Ie({fn:e,priority:"effect"}),Ne=(e,t,r)=>Ie({fn:e,safe:1,filter:t,priority:r&&"effect"}),Oe=(e,t,r)=>Ae({store:e,to:t?z:"a",priority:r&&"sampler",batch:1}),Fe=(e=Ce,t)=>Ie({fn:e,pure:1,filter:t}),De={mov:Ae,compute:Ie,filter:({fn:e,pure:t})=>Ie({fn:e,filter:1,pure:t}),run:qe},Re=e=>({id:se(),current:e}),ze=({current:e})=>e,_e=(e,t)=>{e.before||(e.before=[]),G(e.before,t)},Pe=null;const Ve=(e,t)=>{if(!e)return t;if(!t)return e;let r;return(e.v.type===t.v.type&&e.v.id>t.v.id||He(e.v.type)>He(t.v.type))&&(r=e,e=t,t=r),r=Ve(e.r,t),e.r=e.l,e.l=r,e},Ee=[];let Be=0;for(;Be<6;)G(Ee,{first:null,last:null,size:0}),Be+=1;const Le=()=>{for(let e=0;e<6;e++){let t=Ee[e];if(t.size>0){if(3===e||4===e){t.size-=1;let e=Pe.v;return Pe=Ve(Pe.l,Pe.r),e}1===t.size&&(t.last=null);let r=t.first;return t.first=r.r,t.size-=1,r.v}}},Te=(e,t,r,n,a,o)=>We(0,{a:null,b:null,node:r,parent:n,value:a,page:t,scope:o},e),We=(e,t,r,n=0)=>{let a=He(r),o=Ee[a],l={v:{idx:e,stack:t,type:r,id:n},l:null,r:null};3===a||4===a?Pe=Ve(Pe,l):(0===o.size?o.first=l:o.last.r=l,o.last=l),o.size+=1},He=e=>{switch(e){case'child':return 0;case'pure':return 1;case'read':return 2;case"barrier":return 3;case"sampler":return 4;case"effect":return 5;default:return-1}},Ue=new Set;let Ge,Je=1,Ke=0,Qe=0,Xe=null,Ye=e=>{Ge=e},Ze=e=>{Xe=e};const et=(e,t)=>{if(e){for(;e&&!e.reg[t];)e=te(e);if(e)return e}return null};let tt=(e,t,r,n,a)=>{let o=et(e,n.id);return o?o.reg[n.id]:t?(rt(t,n,a),t.reg[n.id]):n},rt=(e,r,n,a,o)=>{let l=e.reg,i=r.sid;if(l[r.id])return;let s={id:r.id,current:r.current};if(i&&i in e.sidValuesMap&&!(i in e.sidIdMap))s.current=e.sidValuesMap[i];else if(r.before&&!o){let o=0,i=n||!r.noInit||a;t(r.before,(t=>{switch(t.type){case R:{let r=t.from;if(r||t.fn){r&&rt(e,r,n,a);let o=r&&l[r.id].current;i&&(s.current=t.fn?t.fn(o):o)}break}case'field':o||(o=1,s.current=Array.isArray(s.current)?[...s.current]:{...s.current}),rt(e,t.from,n,a),i&&(s.current[t.field]=l[l[t.from.id].id].current)}}))}i&&(e.sidIdMap[i]=r.id),l[r.id]=s};const nt=(e,t,r)=>{try{return t(Z(r),e.scope,r)}catch(t){console.error(t),e.fail=1}};let at=(t,r={})=>(he(t)&&(at(t.or,r),e(t,((e,t)=>{be(e)||'or'===t||'and'===t||(r[t]=e)})),at(t.and,r)),r);const ot=(e,t)=>{U(e.next,t),U(Q(e),t),U(X(e),t)},lt=(e,t,r)=>{let n;e.next.length=0,e.seq.length=0,e.scope=null;let a=X(e);for(;n=a.pop();)ot(n,e),(t||r&&'sample'!==ne(e,'op')||"crosslink"===n.family.type)&&lt(n,t,'on'!==ne(n,'op')&&r);for(a=Q(e);n=a.pop();)ot(n,e),r&&"crosslink"===n.family.type&&lt(n,t,'on'!==ne(n,'op')&&r)},st=e=>e.clear();let ft=(e,{deep:t}={})=>{let r=0;if(e.ownerSet&&e.ownerSet.delete(e),V(e))st(ee(e));else if(L(e)){r=1;let t=e.history;st(t.events),st(t.effects),st(t.stores),st(t.domains)}lt(K(e),!!t,r)},ut=e=>{let t=()=>ft(e);return t.unsubscribe=t,t},ct=(e,t,r,n,o)=>a({node:r,parent:e,child:t,scope:{fn:o},meta:{op:n},family:{owners:[e,t],links:t},regional:1}),dt=e=>{let t='forward',[{from:r,to:n},o]=f(e,1);return we(r,t,'"from"'),we(n,t,'"to"'),xe(t,n,'to'),ut(a({parent:r,child:n,meta:{op:t,config:o},family:{},regional:1}))},pt=(e,t)=>(r(ye(t),'.watch argument should be a function'),ut(a({scope:{fn:t},node:[qe({fn:Ce})],parent:e,meta:{op:'watch'},family:{owners:e},regional:1}))),mt=(e,t,r="event")=>{te(e)&&te(e).hooks[r](t)},gt=(e,t,r,n)=>{let a="domain"===e,o=ie(),l=at({or:n,and:'string'==typeof r?{name:r}:r}),{parent:i=null,sid:f=null,named:u=null}=l,c=u||l.name||(a?'':o),d=s(c,i),p={op:t.kind=e,name:t.shortName=c,sid:t.sid=de(f),named:u,unitId:t.id=o,serialize:l.serialize,derived:l.derived,config:l};if(t.parent=i,t.compositeName=d,t.defaultConfig=l,t.thru=e=>(J(0,'thru','js pipe'),e(t)),t.getType=()=>d.fullName,!a){t.subscribe=e=>(ve(e),t.watch(ye(e)?e:t=>e.next&&e.next(t))),t[D]=()=>t;let e=ce();e&&(p.nativeTemplate=e)}return p},ht=e=>c({named:e});const yt=(e,t,r,n)=>{let a;he(r)&&(a=r,r=r.fn);let o=c({name:`${e.shortName} \u2192 *`,derived:1,and:a});return ct(e,o,n,t,r),o},bt=(e,t,r,n,a)=>{let o=Y(t),l=Ae({store:o,to:"a",priority:'read'});r===R&&(l.data.softRead=1);let i=[l,Fe(n)];return u('storeOnMap',o,i,V(e)&&Y(e)),ct(e,t,i,r,a)},vt=(t,n,a,o,i)=>{let s=t?e=>e.slice():e=>({...e}),f=t?[]:{},c=s(f),p=Re(c),m=Re(1);p.type=t?'list':'shape',p.noInit=1,u('combineBase',p,m);let g=d(c,{name:l(a),derived:1,and:o}),h=Y(g);h.noInit=1,ae(g,'isCombine',1);let y=Oe(p);y.order={priority:'barrier'};let b=[Ne(((e,t,r)=>(r.scope&&!r.scope.reg[p.id]&&(r.c=1),e))),y,Ae({store:m,to:'b'}),Ne(((e,{key:t},r)=>{if(r.c||e!==r.a[t])return n&&r.b&&(r.a=s(r.a)),r.a[t]=e,1}),1),Ae({from:"a",target:p}),Ae({from:"value",store:0,target:m}),Ae({from:"value",store:1,target:m,priority:"barrier",batch:1}),Oe(p,1),i&&Fe()];return e(a,((e,t)=>{if(!V(e))return r(!_(e)&&!be(e),`combine expects a store in a field ${t}`),void(c[t]=f[t]=e);f[t]=e.defaultState,c[t]=e.getState();let n=ct(e,g,b,'combine',i);n.scope.key=t;let a=Y(e);_e(p,{type:'field',field:t,from:a}),u('combineField',a,n)})),g.defaultShape=a,_e(h,{type:R,from:p,fn:i}),ce()||(g.defaultState=i?h.current=i(c):f),g};let kt=(e,t,r)=>{try{return[1,e(...r)]}catch(e){return t(e),[0,null]}},wt=(e,t,r,n,a)=>l=>o({target:[n,xt],params:[r?{status:'done',params:e,result:l}:{status:'fail',params:e,error:l},{value:l,fn:r?t.rs:t.rj}],defer:1,page:a.page,scope:re(a)});const xt=a({node:[qe({fn:({fn:e,value:t})=>e(t)})],meta:{op:'fx',fx:'sidechain'}}),St=['source','clock','target'],$t=(e,t)=>e+`: ${t} should be defined`;let Ct=(e,t,n,a,o,l,i,s,f,m,g,h)=>{let y=!!o;r(!be(n)||!be(t),$t(e,'either source or clock'));let b=0;be(n)?b=1:_(n)||(n=p(n)),be(t)?t=n:(we(t,e,'clock'),Array.isArray(t)&&(t=w(t))),b&&(n=t),s||i||(i=n.shortName);let v='none';(g||a)&&(_(a)?v='unit':(r(ye(a),'`filter` should be function or unit'),v='fn')),o?(we(o,e,'target'),xe(e,o)):'none'===v&&m&&V(n)&&V(t)?o=d(l?l(ze(Y(n)),ze(Y(t))):ze(Y(n)),{name:i,sid:h,or:s}):(o=c({name:i,derived:1,or:s}),u('sampleTarget',K(o)));let k=Re(),x=[];if('unit'===v){let[r,n]=jt(a,o,t,k,e);x=[...Mt(n),...Mt(r)]}let[S,$]=jt(n,o,t,k,e);return me(n,[ct(t,o,[u('sampleSourceLoader'),Ae({from:z,target:k}),...Mt($),Oe(S,1,f),...x,Oe(k),'fn'===v&&Fe(((e,t,{a:r})=>a(e,r)),1),l&&Fe(Se),u('sampleSourceUpward',y)],e,l)]),o};const Mt=e=>[Oe(e),Ne(((e,t,{a:r})=>r),1)],jt=(e,t,r,n,o)=>{let l=V(e),i=l?Y(e):Re(),s=Re(l);return l||a({parent:e,node:[Ae({from:z,target:i}),Ae({from:"value",store:1,target:s})],family:{owners:[e,t,r],links:t},meta:{op:o},regional:1}),u('sampleSource',s,i,n),[i,s]},At=(e,t,r,n)=>{let a=e[t];a&&o({target:a,params:Array.isArray(a)?a.map((()=>r)):r,defer:1,stack:n})},It="22.2.0";export{j as allSettled,y as attach,ft as clearNode,p as combine,b as createApi,v as createDomain,h as createEffect,c as createEvent,a as createNode,d as createStore,m as createStoreObject,q as fork,dt as forward,k as fromObservable,$ as guard,N as hydrate,W as is,o as launch,w as merge,C as restore,S as sample,O as scopeBind,F as serialize,i as setStoreName,M as split,De as step,It as version,pe as withFactory,n as withRegion};
//# sourceMappingURL=effector.mjs.map
